plugins {
    id 'groovy'
    id 'java-gradle-plugin'
    id 'maven-publish'
    id 'com.gradle.plugin-publish' version '0.10.1'
    id 'pl.allegro.tech.build.axion-release' version '1.11.0'
}

description 'A Gradle init script plugin that dynamically updates buildscript and project repositories to use the configured mirror URLs.'
group 'co.insecurity'
scmVersion {
    tag {
        prefix = 'v'
        versionSeparator = ''
    }
    hooks {
        pre 'fileUpdate', [file: 'README.md', pattern: {v, c -> /\b$v\b/}, replacement: {v, c -> /$v/}]
        pre 'commit'
    }
}
project.version = scmVersion.version
logger.info("version: ${project.version}")

tasks.withType(GroovyCompile) {
    sourceCompatibility = JavaVersion.VERSION_11
    targetCompatibility = JavaVersion.VERSION_1_8
}

apply from: "${rootDir}/gradle/functional-test.gradle"
apply from: "${rootDir}/gradle/maven-publish.gradle"

repositories {
    mavenCentral()
    jcenter()
}

dependencies {
    implementation localGroovy()
    implementation gradleApi()
    testImplementation gradleTestKit()
    testImplementation("org.spockframework:spock-core:1.3-groovy-2.5") {
        exclude module: "groovy-all"
    }
    testImplementation 'org.mock-server:mockserver-netty:5.9.0'
    testRuntimeOnly files(pluginUnderTestMetadata)
}

gradlePlugin {
    plugins {
        repositoryMirrorsPlugin {
            id = 'co.insecurity.repository-mirrors'
            implementationClass = 'co.insecurity.gradle.repository_mirrors.RepositoryMirrorsPlugin'
        }
    }
}

pluginBundle {
    website = "https://github.com/milo-minderbinder/${rootProject.name}"
    vcsUrl = "https://github.com/milo-minderbinder/${rootProject.name}.git"
    tags = ['repository', 'mirror', 'mirrors', 'artifactory']
    plugins {
        repositoryMirrorsPlugin {
            displayName = 'Repository Mirrors Gradle Plugin'
            description = "${rootProject.description}"
        }
    }
}
